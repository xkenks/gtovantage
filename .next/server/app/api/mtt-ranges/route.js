"use strict";(()=>{var e={};e.id=421,e.ids=[421],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},4017:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>N,patchFetch:()=>O,requestAsyncStorage:()=>k,routeModule:()=>C,serverHooks:()=>T,staticGenerationAsyncStorage:()=>S});var n={};s.r(n),s.d(n,{DELETE:()=>F,GET:()=>f,PATCH:()=>v,POST:()=>R});var r=s(9303),o=s(8716),a=s(670),u=s(7070),l=s(2048),c=s.n(l),i=s(5315),g=s.n(i),p=s(1482),d=s.n(p);let m=null,h=null,y="/tmp",x=g().join(y,"mtt-ranges.json"),j=process.env.JWT_SECRET||"gto-vantage-admin-secret-key-2024";function D(e){try{let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return!1;let s=t.substring(7),n=d().verify(s,j);return"admin"===n.role}catch(e){return!1}}async function f(e){console.log("\uD83C\uDFAF GET /api/mtt-ranges 開始");try{if(m&&h)return console.log("\uD83C\uDFAF キャッシュからデータを返却:",{lastUpdated:h,totalPositions:m.metadata.totalPositions,totalHands:m.metadata.totalHands,hasRanges:!!m.ranges,rangesCount:m.ranges?Object.keys(m.ranges).length:0}),u.NextResponse.json(m);if(!c().existsSync(x)){console.log("\uD83C\uDFAF ファイルが存在しないため、空のデータを返却");let e={version:"1.0.0",lastUpdated:new Date().toISOString(),ranges:{},metadata:{totalPositions:0,totalHands:0,creator:"System",environment:"production"}};return u.NextResponse.json(e)}console.log("\uD83C\uDFAF ファイルからデータを読み込み開始");let e=c().readFileSync(x,"utf8"),t=JSON.parse(e);return m=t,h=t.lastUpdated,console.log("\uD83C\uDFAF ファイルからデータを読み込み、キャッシュを更新:",{lastUpdated:h,totalPositions:t.metadata.totalPositions,totalHands:t.metadata.totalHands,hasRanges:!!t.ranges,rangesCount:t.ranges?Object.keys(t.ranges).length:0,fileSize:e.length}),u.NextResponse.json(t)}catch(e){return console.error("MTTレンジデータの読み込みエラー:",e),u.NextResponse.json({error:"データの読み込みに失敗しました"},{status:500})}}async function R(e){if(console.log("\uD83C\uDFAF POST /api/mtt-ranges 開始"),!D(e))return console.log("❌ 管理者認証失敗"),u.NextResponse.json({error:"管理者権限が必要です"},{status:403});console.log("✅ 管理者認証成功");try{let{ranges:t,metadata:s}=await e.json();if(console.log("\uD83C\uDFAF リクエストボディ:",{hasRanges:!!t,rangesType:typeof t,rangesKeys:t?Object.keys(t):[],rangesCount:t?Object.keys(t).length:0,metadata:s}),!t||"object"!=typeof t)return console.log("❌ 無効なレンジデータ"),u.NextResponse.json({error:"無効なレンジデータです"},{status:400});let n=Object.keys(t).length,r=Object.values(t).reduce((e,t)=>e+Object.keys(t).length,0),o={version:"1.0.0",lastUpdated:new Date().toISOString(),ranges:t,metadata:{totalPositions:n,totalHands:r,creator:s?.creator||"Admin",environment:"production"}};return console.log("\uD83C\uDFAF Vercel環境: メモリキャッシュを更新"),m=o,h=o.lastUpdated,console.log(`🔒 管理者がMTTレンジデータを保存（メモリキャッシュ更新）: ${n}ポジション, ${r}ハンド`),console.log("\uD83C\uDFAF キャッシュ更新詳細:",{hasCache:!!m,lastUpdated:h,hasRanges:!!m.ranges,rangesCount:m.ranges?Object.keys(m.ranges).length:0,rangesKeys:m.ranges?Object.keys(m.ranges).slice(0,5):[]}),u.NextResponse.json({success:!0,message:"システム全体にレンジデータを保存しました（メモリキャッシュ更新）",metadata:o.metadata,note:"メモリキャッシュが更新されました。他のユーザーは「システム読み込み」で最新データを取得できます。"})}catch(t){console.error("MTTレンジデータの保存エラー:",t);let e=t instanceof Error?t.message:"Unknown error";return u.NextResponse.json({error:`データの保存に失敗しました: ${e}`},{status:500})}}async function F(e){if(!D(e))return u.NextResponse.json({error:"管理者権限が必要です"},{status:403});try{return c().existsSync(x)&&c().unlinkSync(x),m=null,h=null,console.log("\uD83D\uDD12 管理者がシステム全体のレンジデータを削除しました（ファイル + キャッシュ）"),u.NextResponse.json({success:!0,message:"システム全体のレンジデータを削除しました（ファイル + キャッシュ）"})}catch(e){return console.error("MTTレンジデータの削除エラー:",e),u.NextResponse.json({error:"データの削除に失敗しました"},{status:500})}}async function v(e){if(!D(e))return u.NextResponse.json({error:"管理者権限が必要です"},{status:403});try{let{action:t}=await e.json();if("clear-cache"===t)return m=null,h=null,console.log("\uD83D\uDD12 管理者がキャッシュをクリアしました"),u.NextResponse.json({success:!0,message:"キャッシュをクリアしました"});return u.NextResponse.json({success:!0,message:"キャッシュの状態",cache:{hasCache:!!m,lastUpdated:h,totalPositions:m?.metadata.totalPositions||0,totalHands:m?.metadata.totalHands||0}})}catch(e){return console.error("キャッシュ操作エラー:",e),u.NextResponse.json({error:"キャッシュ操作に失敗しました"},{status:500})}}c().existsSync(y)||c().mkdirSync(y,{recursive:!0});let C=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/mtt-ranges/route",pathname:"/api/mtt-ranges",filename:"route",bundlePath:"app/api/mtt-ranges/route"},resolvedPagePath:"/Users/kensuke/Desktop/gtovantage/src/app/api/mtt-ranges/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:k,staticGenerationAsyncStorage:S,serverHooks:T}=C,N="/api/mtt-ranges/route";function O(){return(0,a.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:S})}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),n=t.X(0,[276,972,482],()=>s(4017));module.exports=n})();